{
  "hash": "1583d8c48cae3847ffb1c001ce413684",
  "result": {
    "markdown": "---\ntitle: \"Deep Learning\"\nauthor: \"Agam Safaruddin\"\n---\n\n::: callout-note\nPlease see 'deep-learning.ipynb' in the github work folder. Tensorflow package installation in Rstudio is having problems with the currently installed tensorflow in python in my computer. So please look at the 'deep-learning.ipynb'.\n:::\n\n\n# Libraries\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-1_b4ad45db92aa30db9bcc7e2ed5cd95f8'}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'tidyverse' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'ggplot2' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'tibble' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'tidyr' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'readr' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'purrr' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'dplyr' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'stringr' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'forcats' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'lubridate' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n#> ✔ dplyr     1.1.2     ✔ readr     2.1.4\n#> ✔ forcats   1.0.0     ✔ stringr   1.5.0\n#> ✔ ggplot2   3.4.2     ✔ tibble    3.2.1\n#> ✔ lubridate 1.9.2     ✔ tidyr     1.3.0\n#> ✔ purrr     1.0.1     \n#> ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n#> ✖ dplyr::filter() masks stats::filter()\n#> ✖ dplyr::lag()    masks stats::lag()\n#> ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n:::\n\n```{.r .cell-code}\nlibrary(keras)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'keras' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n```{.r .cell-code}\nlibrary(lime)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'lime' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> \n#> Attache Paket: 'lime'\n#> \n#> Das folgende Objekt ist maskiert 'package:dplyr':\n#> \n#>     explain\n```\n:::\n\n```{.r .cell-code}\nlibrary(rsample)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'rsample' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n```{.r .cell-code}\nlibrary(recipes)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'recipes' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> \n#> Attache Paket: 'recipes'\n#> \n#> Das folgende Objekt ist maskiert 'package:stringr':\n#> \n#>     fixed\n#> \n#> Das folgende Objekt ist maskiert 'package:stats':\n#> \n#>     step\n```\n:::\n\n```{.r .cell-code}\nlibrary(yardstick)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'yardstick' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> \n#> Attache Paket: 'yardstick'\n#> \n#> Das folgende Objekt ist maskiert 'package:keras':\n#> \n#>     get_weights\n#> \n#> Das folgende Objekt ist maskiert 'package:readr':\n#> \n#>     spec\n```\n:::\n\n```{.r .cell-code}\nlibrary(corrr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'corrr' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n```{.r .cell-code}\nlibrary(readxl)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Warning: Paket 'readxl' wurde unter R Version 4.2.3 erstellt\n```\n:::\n\n```{.r .cell-code}\nlibrary(forcats)\n```\n:::\n\n\n\n# import data\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-2_21e2a0fb38f2e149d58e386c0bde3e30'}\n\n```{.r .cell-code}\nchurn_data_raw <- read_csv(\"datas/WA_Fn-UseC_-Telco-Customer-Churn.csv\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Rows: 7043 Columns: 21\n#> ── Column specification ────────────────────────────────────────────────────────\n#> Delimiter: \",\"\n#> chr (17): customerID, gender, Partner, Dependents, PhoneService, MultipleLin...\n#> dbl  (4): SeniorCitizen, tenure, MonthlyCharges, TotalCharges\n#> \n#> ℹ Use `spec()` to retrieve the full column specification for this data.\n#> ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n:::\n\n```{.r .cell-code}\nglimpse(churn_data_raw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> Rows: 7,043\n#> Columns: 21\n#> $ customerID       <chr> \"7590-VHVEG\", \"5575-GNVDE\", \"3668-QPYBK\", \"7795-CFOCW…\n#> $ gender           <chr> \"Female\", \"Male\", \"Male\", \"Male\", \"Female\", \"Female\",…\n#> $ SeniorCitizen    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n#> $ Partner          <chr> \"Yes\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"Yes…\n#> $ Dependents       <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"No\", \"Yes\", \"No\", \"No\"…\n#> $ tenure           <dbl> 1, 34, 2, 45, 2, 8, 22, 10, 28, 62, 13, 16, 58, 49, 2…\n#> $ PhoneService     <chr> \"No\", \"Yes\", \"Yes\", \"No\", \"Yes\", \"Yes\", \"Yes\", \"No\", …\n#> $ MultipleLines    <chr> \"No phone service\", \"No\", \"No\", \"No phone service\", \"…\n#> $ InternetService  <chr> \"DSL\", \"DSL\", \"DSL\", \"DSL\", \"Fiber optic\", \"Fiber opt…\n#> $ OnlineSecurity   <chr> \"No\", \"Yes\", \"Yes\", \"Yes\", \"No\", \"No\", \"No\", \"Yes\", \"…\n#> $ OnlineBackup     <chr> \"Yes\", \"No\", \"Yes\", \"No\", \"No\", \"No\", \"Yes\", \"No\", \"N…\n#> $ DeviceProtection <chr> \"No\", \"Yes\", \"No\", \"Yes\", \"No\", \"Yes\", \"No\", \"No\", \"Y…\n#> $ TechSupport      <chr> \"No\", \"No\", \"No\", \"Yes\", \"No\", \"No\", \"No\", \"No\", \"Yes…\n#> $ StreamingTV      <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"Yes\", \"Yes\", \"No\", \"Ye…\n#> $ StreamingMovies  <chr> \"No\", \"No\", \"No\", \"No\", \"No\", \"Yes\", \"No\", \"No\", \"Yes…\n#> $ Contract         <chr> \"Month-to-month\", \"One year\", \"Month-to-month\", \"One …\n#> $ PaperlessBilling <chr> \"Yes\", \"No\", \"Yes\", \"No\", \"Yes\", \"Yes\", \"Yes\", \"No\", …\n#> $ PaymentMethod    <chr> \"Electronic check\", \"Mailed check\", \"Mailed check\", \"…\n#> $ MonthlyCharges   <dbl> 29.85, 56.95, 53.85, 42.30, 70.70, 99.65, 89.10, 29.7…\n#> $ TotalCharges     <dbl> 29.85, 1889.50, 108.15, 1840.75, 151.65, 820.50, 1949…\n#> $ Churn            <chr> \"No\", \"No\", \"Yes\", \"No\", \"Yes\", \"Yes\", \"No\", \"No\", \"Y…\n```\n:::\n:::\n\n\n# preprocessing\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-3_0dd48e6c5206c9a6c046678951638da4'}\n\n```{.r .cell-code}\nchurn_data_tbl <- churn_data_raw %>%\n                  select(-customerID) %>%\n                  na.omit(churn_data_raw$TotalCharges) %>%\n                  select(Churn, everything())\n\n#churn_data_tbl\n```\n:::\n\n\n# split 80/20\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-4_59e3765ded4280838c532339497b4f1f'}\n\n```{.r .cell-code}\n# Split test/training sets\nset.seed(100)\n\ntrain_test_split <- rsample::initial_split(churn_data_tbl, prop = 0.8)\ntrain_test_split\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> <Training/Testing/Total>\n#> <5625/1407/7032>\n```\n:::\n\n```{.r .cell-code}\n## <Analysis/Assess/Total>\n## <5626/1406/7032>\n\n# Retrieve train and test sets\ntrain_tbl <- training(train_test_split)\ntest_tbl  <- testing(train_test_split)\n```\n:::\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-5_ea661b47da0131dd7f76f160addcd26d'}\n\n```{.r .cell-code}\nchurn_data_tbl %>% ggplot(aes(x = tenure)) + \n  geom_histogram(bins = 6, color = \"white\", fill =  \"#2DC6D6\") +\n  labs(\n    title = \"Tenure Counts With Six Bins\",\n    x     = \"tenure (month)\"\n  )\n```\n\n::: {.cell-output-display}\n![](06_deep_learning_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-6_8af11aea7c0c819743fd73c7bf52ecce'}\n\n```{.r .cell-code}\n# Determine if log transformation improves correlation \n# between TotalCharges and Churn\n\ntrain_tbl %>%\n    select(Churn, TotalCharges) %>%\n    mutate(\n        Churn = Churn %>% as.factor() %>% as.numeric(),\n        LogTotalCharges = log(TotalCharges)\n        ) %>%\n    correlate() %>%\n    focus(Churn) %>%\n    fashion()\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> Correlation computed with\n#> • Method: 'pearson'\n#> • Missing treated using: 'pairwise.complete.obs'\n```\n:::\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"term\"],\"name\":[1],\"type\":[\"noquote\"],\"align\":[\"right\"]},{\"label\":[\"Churn\"],\"name\":[2],\"type\":[\"noquote\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"TotalCharges\",\"2\":\"-.21\"},{\"1\":\"LogTotalCharges\",\"2\":\"-.25\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-7_bec53b0fc276a3387624e29f6841b5dc'}\n\n```{.r .cell-code}\nchurn_data_tbl %>% \n        pivot_longer(cols      = c(Contract, InternetService, MultipleLines, PaymentMethod), \n                     names_to  = \"feature\", \n                     values_to = \"category\") %>% \n        ggplot(aes(category)) +\n          geom_bar(fill = \"#2DC6D6\") +\n          facet_wrap(~ feature, scales = \"free\") +\n          labs(\n            title = \"Features with multiple categories: Need to be one-hot encoded\"\n          ) +\n          theme(axis.text.x = element_text(angle = 25, \n                                           hjust = 1))\n```\n\n::: {.cell-output-display}\n![](06_deep_learning_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n# Preprocessing with recipes\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-8_977576305a2ee8d6d6c0bb2ba5c4121f'}\n\n```{.r .cell-code}\nrec_obj <- recipe(Churn ~ ., data = train_tbl) %>%\n    step_rm(Churn) %>% \n    step_discretize(tenure, options = list(cuts = 6)) %>%\n    step_log(TotalCharges) %>%\n    step_dummy(all_nominal(), -all_outcomes(), one_hot = T) %>%\n    step_center(all_predictors(), -all_outcomes()) %>%\n    step_scale(all_predictors(), -all_outcomes()) %>%\n    prep(data = train_tbl)\n```\n:::\n\n\n# Bake\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-9_6d996f659f168d72167181ba5faca4de'}\n\n```{.r .cell-code}\n# Predictors\nx_train_tbl <- bake(rec_obj , new_data = train_tbl )\nx_test_tbl  <- bake(rec_obj , new_data = test_tbl )\n```\n:::\n\n::: {.cell hash='06_deep_learning_cache/html/unnamed-chunk-10_906213e58024f8de09b798f3fb136e2d'}\n\n```{.r .cell-code}\n# Response variables for training and testing sets\ny_train_vec <- ifelse(churn_data_tbl$Churn == \"Yes\", 1, 0)\ny_test_vec  <- ifelse(test_tbl$Churn == \"Yes\", 1, 0)\n```\n:::\n\n\n\n# ANN\n\n# Building our Artificial Neural Network\nmodel_keras <- keras_model_sequential()\n\nmodel_keras %>% \n    # First hidden layer\n    layer_dense(\n        units              = 16, \n        kernel_initializer = \"uniform\", \n        activation         = \"relu\", \n        input_shape        = ncol(x_train_tbl)) %>% \n    # Dropout to prevent overfitting\n    layer_dropout(rate = 0.1) %>%\n    # Second hidden layer\n    layer_dense(\n        units              = 16, \n        kernel_initializer = \"uniform\", \n        activation         = \"relu\") %>% \n    # Dropout to prevent overfitting\n    layer_dropout(rate = 0.1) %>%\n    # Output layer\n    layer_dense(\n        units              = 1, \n        kernel_initializer = \"uniform\", \n        activation         = \"sigmoid\") %>% \n    # Compile ANN\n    compile(\n        optimizer = 'adam',\n        loss      = 'binary_crossentropy',\n        metrics   = c('accuracy')\n    )\nmodel_keras\n\n\n# Training\n\n# Fit the keras model to the training data\nfit_keras <- fit(\n    model_keras,\n    x = as.matrix(x_train_tbl),\n    y = y_train_vec,\n    batch_size = 50,\n    epochs = 35,\n    validation_split = 0.3\n)\n\n\n\n\nfit_keras\n\n\n# Plot\n\n# Plot the training/validation history of our Keras model\nplot(fit_keras) +\n#geom_smooth(formula = y ~ x, method = \"auto\", se = FALSE, color = \"blue\") +\n  labs(title = \"Deep Learning Training Results\") +\n  theme(legend.position  = \"bottom\", \n        strip.placement  = \"inside\",\n        strip.background = element_rect(fill = \"grey\"))\n\n\n# make predictions\n* tensorflow version is different, therefore the code has been adjusted\n\n# Predicted Class\n#yhat_keras_class_vec <- predict_classes(object = model_keras, x = as.matrix(x_test_tbl)) %>%\n#    as.vector()\n\n# Predicted Class Probability\n#yhat_keras_prob_vec  <- predict_proba(object = model_keras, x = as.matrix(x_test_tbl)) %>%\n#    as.vector()\n\n# Predicted Class\nyhat_keras_class_vec <- predict(object = model_keras, x = as.matrix(x_test_tbl)) %>%\n  k_argmax() %>% as.vector()\n\n# Predicted Class Probability\nyhat_keras_prob_vec <- predict(object = model_keras, x = as.matrix(x_test_tbl)) %>% as.vector()\n\n\n\n\n# Inspect performance\n\nestimates_keras_tbl <- tibble(\n    truth      = as.factor(y_test_vec) %>% fct_recode(yes = \"1\", no = \"0\"),\n    estimate   = as.factor(yhat_keras_class_vec) %>% fct_recode(yes = \"1\", no = \"0\"),\n    class_prob = yhat_keras_prob_vec\n)\n\nestimates_keras_tbl\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}